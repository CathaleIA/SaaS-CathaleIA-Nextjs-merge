import { ChangeDetectorRef, Component, ContentChildren, Input, ViewEncapsulation, } from '@angular/core';
import { configureComponent, defaultAuthHubHandler, listenToAuthHub, translate, } from '@aws-amplify/ui';
import { AmplifySlotDirective } from '../../../../utilities/amplify-slot/amplify-slot.directive';
import { CustomComponentsService } from '../../../../services/custom-components.service';
import { AuthenticatorService } from '../../../../services/authenticator.service';
import { VERSION } from '../../../../../version';
export class AuthenticatorComponent {
    constructor(authenticator, contextService, changeDetector) {
        this.authenticator = authenticator;
        this.contextService = contextService;
        this.changeDetector = changeDetector;
        this.customComponentQuery = null;
        // translated texts
        this.signInTitle = translate('Sign In');
        this.signUpTitle = translate('Create Account');
        this.hasInitialized = false;
        this.isHandlingHubEvent = false;
    }
    ngOnInit() {
        const { initialState, loginMechanisms, services, signUpAttributes, socialProviders, formFields, } = this;
        configureComponent({
            packageName: '@aws-amplify/ui-angular',
            version: VERSION,
        });
        const { authService, initializeMachine } = this.authenticator;
        this.unsubscribeHub = listenToAuthHub(authService, (data, service) => {
            defaultAuthHubHandler(data, service);
            /**
             * Hub events aren't properly caught by Angular, because they are
             * synchronous events. Angular tracks async network events and
             * html events, but not synchronous events like hub.
             *
             * On any notable hub events, we run change detection manually.
             */
            this.changeDetector.detectChanges();
            /**
             * Hub events that we handle can lead to multiple state changes:
             * e.g. `authenticated` -> `signOut` -> initialState.
             *
             * We want to ensure change detection runs all the way, until
             * we reach back to the initial state. Setting the below flag
             * to true to until we reach initial state.
             */
            this.isHandlingHubEvent = true;
        });
        /**
         * Subscribes to state machine changes and sends INIT event
         * once machine reaches 'setup' state.
         */
        this.unsubscribeMachine = this.authenticator.subscribe(() => {
            const { route } = this.authenticator;
            if (this.isHandlingHubEvent) {
                this.changeDetector.detectChanges();
                const initialStateWithDefault = initialState !== null && initialState !== void 0 ? initialState : 'signIn';
                // We can stop manual change detection if we're back to the initial state
                if (route === initialStateWithDefault) {
                    this.isHandlingHubEvent = false;
                }
            }
            if (!this.hasInitialized && route === 'setup') {
                initializeMachine({
                    initialState,
                    loginMechanisms,
                    services,
                    signUpAttributes,
                    socialProviders,
                    formFields,
                });
                this.hasInitialized = true;
            }
        }).unsubscribe;
        /**
         * handling translations after content init, because authenticator and its
         * translations might be initialized before the main app's `ngOnInit` is run.
         */
        this.signInTitle = translate('Sign In');
        this.signUpTitle = translate('Create Account');
    }
    /**
     * Lifecycle Methods
     */
    ngAfterContentInit() {
        this.contextService.customComponents = this.mapCustomComponents(this.customComponentQuery);
    }
    ngOnDestroy() {
        if (this.unsubscribeMachine)
            this.unsubscribeMachine();
        if (this.unsubscribeHub)
            this.unsubscribeHub();
    }
    /**
     * Class Functions
     */
    // context passed to "authenticated" slot
    get context() {
        return this.authenticator.slotContext;
    }
    get route() {
        return this.authenticator.route;
    }
    onTabChange() {
        const route = this.authenticator.route;
        if (route === 'signIn') {
            this.authenticator.toSignUp();
        }
        else {
            this.authenticator.toSignIn();
        }
    }
    hasTabs() {
        const { route } = this.authenticator;
        return route === 'signIn' || route === 'signUp';
    }
    hasRouteComponent() {
        const { route } = this.authenticator;
        switch (route) {
            case 'authenticated':
            case 'idle':
            case 'setup':
            case 'signOut':
            case 'autoSignIn':
                return false;
            default:
                return true;
        }
    }
    mapCustomComponents(componentQuery) {
        if (!componentQuery)
            return {};
        const customComponents = {};
        componentQuery.forEach((component) => {
            customComponents[component.name] = component.template;
        });
        return customComponents;
    }
}
AuthenticatorComponent.decorators = [
    { type: Component, args: [{
                selector: 'amplify-authenticator',
                template: "<div\n  data-amplify-authenticator\n  [attr.data-variation]=\"variation\"\n  *ngIf=\"hasRouteComponent()\"\n>\n  <div data-amplify-container>\n    <amplify-slot name=\"header\" [context]=\"context\"></amplify-slot>\n    <div\n      data-amplify-router\n      [attr.data-amplify-router-content]=\"hasTabs() ? undefined : ''\"\n    >\n      <amplify-tabs\n        (tabChange)=\"onTabChange()\"\n        *ngIf=\"(route === 'signIn' || route === 'signUp') && !hideSignUp\"\n      >\n        <amplify-tab-item\n          [title]=\"signInTitle\"\n          [active]=\"route === 'signIn'\"\n          data-amplify-router-content\n        >\n          <!-- signIn component -->\n          <amplify-slot\n            name=\"sign-in\"\n            [context]=\"context\"\n            *ngIf=\"route === 'signIn'\"\n          >\n            <amplify-sign-in></amplify-sign-in>\n          </amplify-slot>\n        </amplify-tab-item>\n        <amplify-tab-item\n          [title]=\"signUpTitle\"\n          [active]=\"route === 'signUp'\"\n          data-amplify-router-content\n        >\n          <!-- signUp component -->\n          <amplify-slot\n            name=\"sign-up\"\n            [context]=\"context\"\n            *ngIf=\"route === 'signUp'\"\n          >\n            <amplify-sign-up></amplify-sign-up>\n          </amplify-slot>\n        </amplify-tab-item>\n      </amplify-tabs>\n\n      <amplify-slot\n        name=\"sign-in\"\n        [context]=\"context\"\n        *ngIf=\"route === 'signIn' && hideSignUp\"\n      >\n        <amplify-sign-in></amplify-sign-in>\n      </amplify-slot>\n\n      <!-- confirmSignUp content -->\n      <amplify-slot\n        name=\"confirm-sign-up\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmSignUp'\"\n      >\n        <amplify-confirm-sign-up></amplify-confirm-sign-up>\n      </amplify-slot>\n\n      <!-- confirmSignIn content -->\n      <amplify-slot\n        name=\"confirm-sign-in\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmSignIn'\"\n      >\n        <amplify-confirm-sign-in></amplify-confirm-sign-in>\n      </amplify-slot>\n\n      <!-- setupTotp content -->\n      <amplify-slot\n        name=\"setup-totp\"\n        [context]=\"context\"\n        *ngIf=\"route === 'setupTOTP'\"\n      >\n        <amplify-setup-totp></amplify-setup-totp>\n      </amplify-slot>\n\n      <!-- forceNewPassword content -->\n      <amplify-slot\n        name=\"force-new-password\"\n        [context]=\"context\"\n        *ngIf=\"route === 'forceNewPassword'\"\n      >\n        <amplify-force-new-password></amplify-force-new-password>\n      </amplify-slot>\n\n      <!-- resetPassword content -->\n      <amplify-slot\n        name=\"reset-password\"\n        [context]=\"context\"\n        *ngIf=\"route === 'resetPassword'\"\n      >\n        <amplify-reset-password></amplify-reset-password>\n      </amplify-slot>\n\n      <!-- confirmResetPassword content -->\n      <amplify-slot\n        name=\"confirm-reset-password\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmResetPassword'\"\n      >\n        <amplify-confirm-reset-password></amplify-confirm-reset-password>\n      </amplify-slot>\n\n      <!-- verifyUser content -->\n      <amplify-slot\n        name=\"verify-user\"\n        [context]=\"context\"\n        *ngIf=\"route === 'verifyUser'\"\n      >\n        <amplify-verify-user></amplify-verify-user>\n      </amplify-slot>\n\n      <!-- confirmVerifyUser content -->\n      <amplify-slot\n        name=\"confirm-verify-user\"\n        [context]=\"context\"\n        *ngIf=\"route === 'confirmVerifyUser'\"\n      >\n        <amplify-confirm-verify-user></amplify-confirm-verify-user>\n      </amplify-slot>\n    </div>\n\n    <amplify-slot name=\"footer\" [context]=\"context\"></amplify-slot>\n  </div>\n</div>\n\n<!-- signedIn content is rendered outside authenticator so it's not styled by authenticator -->\n<amplify-slot\n  name=\"authenticated\"\n  [context]=\"context\"\n  *ngIf=\"route === 'authenticated'\"\n>\n  <ng-content></ng-content>\n</amplify-slot>\n",
                providers: [CustomComponentsService],
                encapsulation: ViewEncapsulation.None
            },] }
];
AuthenticatorComponent.ctorParameters = () => [
    { type: AuthenticatorService },
    { type: CustomComponentsService },
    { type: ChangeDetectorRef }
];
AuthenticatorComponent.propDecorators = {
    formFields: [{ type: Input }],
    initialState: [{ type: Input }],
    loginMechanisms: [{ type: Input }],
    services: [{ type: Input }],
    signUpAttributes: [{ type: Input }],
    socialProviders: [{ type: Input }],
    variation: [{ type: Input }],
    hideSignUp: [{ type: Input }],
    customComponentQuery: [{ type: ContentChildren, args: [AmplifySlotDirective,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0aGVudGljYXRvci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS1hbmd1bGFyL3NyYy9saWIvY29tcG9uZW50cy9hdXRoZW50aWNhdG9yL2NvbXBvbmVudHMvYXV0aGVudGljYXRvci9hdXRoZW50aWNhdG9yLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsS0FBSyxFQUtMLGlCQUFpQixHQUNsQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBRUwsa0JBQWtCLEVBQ2xCLHFCQUFxQixFQUNyQixlQUFlLEVBRWYsU0FBUyxHQUNWLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMkRBQTJELENBQUM7QUFDakcsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDekYsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDbEYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBUWpELE1BQU0sT0FBTyxzQkFBc0I7SUF3QmpDLFlBQ1UsYUFBbUMsRUFDbkMsY0FBdUMsRUFDdkMsY0FBaUM7UUFGakMsa0JBQWEsR0FBYixhQUFhLENBQXNCO1FBQ25DLG1CQUFjLEdBQWQsY0FBYyxDQUF5QjtRQUN2QyxtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUFkbkMseUJBQW9CLEdBQW9DLElBQUksQ0FBQztRQUVyRSxtQkFBbUI7UUFDWixnQkFBVyxHQUFHLFNBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNuQyxnQkFBVyxHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBRXpDLG1CQUFjLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLHVCQUFrQixHQUFHLEtBQUss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S0FBSzs4QkFDTCxLQUFLO3dCQUNMLEtBQUs7eUJBQ0wsS0FBSzttQ0FFTCxlQUFlLFNBQUMsb0JBQW9CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJDb250ZW50SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENvbXBvbmVudCxcbiAgQ29udGVudENoaWxkcmVuLFxuICBJbnB1dCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIFF1ZXJ5TGlzdCxcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdFbmNhcHN1bGF0aW9uLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEF1dGhlbnRpY2F0b3JNYWNoaW5lT3B0aW9ucyxcbiAgY29uZmlndXJlQ29tcG9uZW50LFxuICBkZWZhdWx0QXV0aEh1YkhhbmRsZXIsXG4gIGxpc3RlblRvQXV0aEh1YixcbiAgU29jaWFsUHJvdmlkZXIsXG4gIHRyYW5zbGF0ZSxcbn0gZnJvbSAnQGF3cy1hbXBsaWZ5L3VpJztcbmltcG9ydCB7IEFtcGxpZnlTbG90RGlyZWN0aXZlIH0gZnJvbSAnLi4vLi4vLi4vLi4vdXRpbGl0aWVzL2FtcGxpZnktc2xvdC9hbXBsaWZ5LXNsb3QuZGlyZWN0aXZlJztcbmltcG9ydCB7IEN1c3RvbUNvbXBvbmVudHNTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvY3VzdG9tLWNvbXBvbmVudHMuc2VydmljZSc7XG5pbXBvcnQgeyBBdXRoZW50aWNhdG9yU2VydmljZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NlcnZpY2VzL2F1dGhlbnRpY2F0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBWRVJTSU9OIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vdmVyc2lvbic7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2FtcGxpZnktYXV0aGVudGljYXRvcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9hdXRoZW50aWNhdG9yLmNvbXBvbmVudC5odG1sJyxcbiAgcHJvdmlkZXJzOiBbQ3VzdG9tQ29tcG9uZW50c1NlcnZpY2VdLCAvLyBtYWtlIHN1cmUgY3VzdG9tIGNvbXBvbmVudHMgYXJlIHNjb3BlZCB0byB0aGlzIGF1dGhlbnRpY2F0b3Igb25seVxuICBlbmNhcHN1bGF0aW9uOiBWaWV3RW5jYXBzdWxhdGlvbi5Ob25lLFxufSlcbmV4cG9ydCBjbGFzcyBBdXRoZW50aWNhdG9yQ29tcG9uZW50XG4gIGltcGxlbWVudHMgT25Jbml0LCBBZnRlckNvbnRlbnRJbml0LCBPbkRlc3Ryb3lcbntcbiAgQElucHV0KCkgZm9ybUZpZWxkczogQXV0aGVudGljYXRvck1hY2hpbmVPcHRpb25zWydmb3JtRmllbGRzJ107XG4gIEBJbnB1dCgpIGluaXRpYWxTdGF0ZTogQXV0aGVudGljYXRvck1hY2hpbmVPcHRpb25zWydpbml0aWFsU3RhdGUnXTtcbiAgQElucHV0KCkgbG9naW5NZWNoYW5pc21zOiBBdXRoZW50aWNhdG9yTWFjaGluZU9wdGlvbnNbJ2xvZ2luTWVjaGFuaXNtcyddO1xuICBASW5wdXQoKSBzZXJ2aWNlczogQXV0aGVudGljYXRvck1hY2hpbmVPcHRpb25zWydzZXJ2aWNlcyddO1xuICBASW5wdXQoKSBzaWduVXBBdHRyaWJ1dGVzOiBBdXRoZW50aWNhdG9yTWFjaGluZU9wdGlvbnNbJ3NpZ25VcEF0dHJpYnV0ZXMnXTtcbiAgQElucHV0KCkgc29jaWFsUHJvdmlkZXJzOiBTb2NpYWxQcm92aWRlcltdO1xuICBASW5wdXQoKSB2YXJpYXRpb246ICdkZWZhdWx0JyB8ICdtb2RhbCc7XG4gIEBJbnB1dCgpIGhpZGVTaWduVXA6IGJvb2xlYW47XG5cbiAgQENvbnRlbnRDaGlsZHJlbihBbXBsaWZ5U2xvdERpcmVjdGl2ZSlcbiAgcHJpdmF0ZSBjdXN0b21Db21wb25lbnRRdWVyeTogUXVlcnlMaXN0PEFtcGxpZnlTbG90RGlyZWN0aXZlPiA9IG51bGw7XG5cbiAgLy8gdHJhbnNsYXRlZCB0ZXh0c1xuICBwdWJsaWMgc2lnbkluVGl0bGUgPSB0cmFuc2xhdGUoJ1NpZ24gSW4nKTtcbiAgcHVibGljIHNpZ25VcFRpdGxlID0gdHJhbnNsYXRlKCdDcmVhdGUgQWNjb3VudCcpO1xuXG4gIHByaXZhdGUgaGFzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBpc0hhbmRsaW5nSHViRXZlbnQgPSBmYWxzZTtcbiAgcHJpdmF0ZSB1bnN1YnNjcmliZU1hY2hpbmU6ICgpID0+IHZvaWQ7XG4gIHByaXZhdGUgdW5zdWJzY3JpYmVIdWI6IFJldHVyblR5cGU8dHlwZW9mIGxpc3RlblRvQXV0aEh1Yj47XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhdXRoZW50aWNhdG9yOiBBdXRoZW50aWNhdG9yU2VydmljZSxcbiAgICBwcml2YXRlIGNvbnRleHRTZXJ2aWNlOiBDdXN0b21Db21wb25lbnRzU2VydmljZSxcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZlxuICApIHt9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgY29uc3Qge1xuICAgICAgaW5pdGlhbFN0YXRlLFxuICAgICAgbG9naW5NZWNoYW5pc21zLFxuICAgICAgc2VydmljZXMsXG4gICAgICBzaWduVXBBdHRyaWJ1dGVzLFxuICAgICAgc29jaWFsUHJvdmlkZXJzLFxuICAgICAgZm9ybUZpZWxkcyxcbiAgICB9ID0gdGhpcztcblxuICAgIGNvbmZpZ3VyZUNvbXBvbmVudCh7XG4gICAgICBwYWNrYWdlTmFtZTogJ0Bhd3MtYW1wbGlmeS91aS1hbmd1bGFyJyxcbiAgICAgIHZlcnNpb246IFZFUlNJT04sXG4gICAgfSk7XG5cbiAgICBjb25zdCB7IGF1dGhTZXJ2aWNlLCBpbml0aWFsaXplTWFjaGluZSB9ID0gdGhpcy5hdXRoZW50aWNhdG9yO1xuXG4gICAgdGhpcy51bnN1YnNjcmliZUh1YiA9IGxpc3RlblRvQXV0aEh1YihhdXRoU2VydmljZSwgKGRhdGEsIHNlcnZpY2UpID0+IHtcbiAgICAgIGRlZmF1bHRBdXRoSHViSGFuZGxlcihkYXRhLCBzZXJ2aWNlKTtcbiAgICAgIC8qKlxuICAgICAgICogSHViIGV2ZW50cyBhcmVuJ3QgcHJvcGVybHkgY2F1Z2h0IGJ5IEFuZ3VsYXIsIGJlY2F1c2UgdGhleSBhcmVcbiAgICAgICAqIHN5bmNocm9ub3VzIGV2ZW50cy4gQW5ndWxhciB0cmFja3MgYXN5bmMgbmV0d29yayBldmVudHMgYW5kXG4gICAgICAgKiBodG1sIGV2ZW50cywgYnV0IG5vdCBzeW5jaHJvbm91cyBldmVudHMgbGlrZSBodWIuXG4gICAgICAgKlxuICAgICAgICogT24gYW55IG5vdGFibGUgaHViIGV2ZW50cywgd2UgcnVuIGNoYW5nZSBkZXRlY3Rpb24gbWFudWFsbHkuXG4gICAgICAgKi9cbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgICAvKipcbiAgICAgICAqIEh1YiBldmVudHMgdGhhdCB3ZSBoYW5kbGUgY2FuIGxlYWQgdG8gbXVsdGlwbGUgc3RhdGUgY2hhbmdlczpcbiAgICAgICAqIGUuZy4gYGF1dGhlbnRpY2F0ZWRgIC0+IGBzaWduT3V0YCAtPiBpbml0aWFsU3RhdGUuXG4gICAgICAgKlxuICAgICAgICogV2Ugd2FudCB0byBlbnN1cmUgY2hhbmdlIGRldGVjdGlvbiBydW5zIGFsbCB0aGUgd2F5LCB1bnRpbFxuICAgICAgICogd2UgcmVhY2ggYmFjayB0byB0aGUgaW5pdGlhbCBzdGF0ZS4gU2V0dGluZyB0aGUgYmVsb3cgZmxhZ1xuICAgICAgICogdG8gdHJ1ZSB0byB1bnRpbCB3ZSByZWFjaCBpbml0aWFsIHN0YXRlLlxuICAgICAgICovXG4gICAgICB0aGlzLmlzSGFuZGxpbmdIdWJFdmVudCA9IHRydWU7XG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBTdWJzY3JpYmVzIHRvIHN0YXRlIG1hY2hpbmUgY2hhbmdlcyBhbmQgc2VuZHMgSU5JVCBldmVudFxuICAgICAqIG9uY2UgbWFjaGluZSByZWFjaGVzICdzZXR1cCcgc3RhdGUuXG4gICAgICovXG4gICAgdGhpcy51bnN1YnNjcmliZU1hY2hpbmUgPSB0aGlzLmF1dGhlbnRpY2F0b3Iuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIGNvbnN0IHsgcm91dGUgfSA9IHRoaXMuYXV0aGVudGljYXRvcjtcblxuICAgICAgaWYgKHRoaXMuaXNIYW5kbGluZ0h1YkV2ZW50KSB7XG4gICAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuXG4gICAgICAgIGNvbnN0IGluaXRpYWxTdGF0ZVdpdGhEZWZhdWx0ID0gaW5pdGlhbFN0YXRlID8/ICdzaWduSW4nO1xuXG4gICAgICAgIC8vIFdlIGNhbiBzdG9wIG1hbnVhbCBjaGFuZ2UgZGV0ZWN0aW9uIGlmIHdlJ3JlIGJhY2sgdG8gdGhlIGluaXRpYWwgc3RhdGVcbiAgICAgICAgaWYgKHJvdXRlID09PSBpbml0aWFsU3RhdGVXaXRoRGVmYXVsdCkge1xuICAgICAgICAgIHRoaXMuaXNIYW5kbGluZ0h1YkV2ZW50ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKCF0aGlzLmhhc0luaXRpYWxpemVkICYmIHJvdXRlID09PSAnc2V0dXAnKSB7XG4gICAgICAgIGluaXRpYWxpemVNYWNoaW5lKHtcbiAgICAgICAgICBpbml0aWFsU3RhdGUsXG4gICAgICAgICAgbG9naW5NZWNoYW5pc21zLFxuICAgICAgICAgIHNlcnZpY2VzLFxuICAgICAgICAgIHNpZ25VcEF0dHJpYnV0ZXMsXG4gICAgICAgICAgc29jaWFsUHJvdmlkZXJzLFxuICAgICAgICAgIGZvcm1GaWVsZHMsXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuaGFzSW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pLnVuc3Vic2NyaWJlO1xuXG4gICAgLyoqXG4gICAgICogaGFuZGxpbmcgdHJhbnNsYXRpb25zIGFmdGVyIGNvbnRlbnQgaW5pdCwgYmVjYXVzZSBhdXRoZW50aWNhdG9yIGFuZCBpdHNcbiAgICAgKiB0cmFuc2xhdGlvbnMgbWlnaHQgYmUgaW5pdGlhbGl6ZWQgYmVmb3JlIHRoZSBtYWluIGFwcCdzIGBuZ09uSW5pdGAgaXMgcnVuLlxuICAgICAqL1xuICAgIHRoaXMuc2lnbkluVGl0bGUgPSB0cmFuc2xhdGUoJ1NpZ24gSW4nKTtcbiAgICB0aGlzLnNpZ25VcFRpdGxlID0gdHJhbnNsYXRlKCdDcmVhdGUgQWNjb3VudCcpO1xuICB9XG5cbiAgLyoqXG4gICAqIExpZmVjeWNsZSBNZXRob2RzXG4gICAqL1xuICBuZ0FmdGVyQ29udGVudEluaXQoKTogdm9pZCB7XG4gICAgdGhpcy5jb250ZXh0U2VydmljZS5jdXN0b21Db21wb25lbnRzID0gdGhpcy5tYXBDdXN0b21Db21wb25lbnRzKFxuICAgICAgdGhpcy5jdXN0b21Db21wb25lbnRRdWVyeVxuICAgICk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy51bnN1YnNjcmliZU1hY2hpbmUpIHRoaXMudW5zdWJzY3JpYmVNYWNoaW5lKCk7XG4gICAgaWYgKHRoaXMudW5zdWJzY3JpYmVIdWIpIHRoaXMudW5zdWJzY3JpYmVIdWIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGFzcyBGdW5jdGlvbnNcbiAgICovXG5cbiAgLy8gY29udGV4dCBwYXNzZWQgdG8gXCJhdXRoZW50aWNhdGVkXCIgc2xvdFxuICBwdWJsaWMgZ2V0IGNvbnRleHQoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRvci5zbG90Q29udGV4dDtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcm91dGUoKSB7XG4gICAgcmV0dXJuIHRoaXMuYXV0aGVudGljYXRvci5yb3V0ZTtcbiAgfVxuXG4gIHB1YmxpYyBvblRhYkNoYW5nZSgpIHtcbiAgICBjb25zdCByb3V0ZSA9IHRoaXMuYXV0aGVudGljYXRvci5yb3V0ZTtcbiAgICBpZiAocm91dGUgPT09ICdzaWduSW4nKSB7XG4gICAgICB0aGlzLmF1dGhlbnRpY2F0b3IudG9TaWduVXAoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hdXRoZW50aWNhdG9yLnRvU2lnbkluKCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGhhc1RhYnMoKSB7XG4gICAgY29uc3QgeyByb3V0ZSB9ID0gdGhpcy5hdXRoZW50aWNhdG9yO1xuICAgIHJldHVybiByb3V0ZSA9PT0gJ3NpZ25JbicgfHwgcm91dGUgPT09ICdzaWduVXAnO1xuICB9XG5cbiAgcHVibGljIGhhc1JvdXRlQ29tcG9uZW50KCkge1xuICAgIGNvbnN0IHsgcm91dGUgfSA9IHRoaXMuYXV0aGVudGljYXRvcjtcblxuICAgIHN3aXRjaCAocm91dGUpIHtcbiAgICAgIGNhc2UgJ2F1dGhlbnRpY2F0ZWQnOlxuICAgICAgY2FzZSAnaWRsZSc6XG4gICAgICBjYXNlICdzZXR1cCc6XG4gICAgICBjYXNlICdzaWduT3V0JzpcbiAgICAgIGNhc2UgJ2F1dG9TaWduSW4nOlxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hcEN1c3RvbUNvbXBvbmVudHMoXG4gICAgY29tcG9uZW50UXVlcnk6IFF1ZXJ5TGlzdDxBbXBsaWZ5U2xvdERpcmVjdGl2ZT5cbiAgKTogUmVjb3JkPHN0cmluZywgVGVtcGxhdGVSZWY8YW55Pj4ge1xuICAgIGlmICghY29tcG9uZW50UXVlcnkpIHJldHVybiB7fTtcbiAgICBjb25zdCBjdXN0b21Db21wb25lbnRzOiBSZWNvcmQ8c3RyaW5nLCBUZW1wbGF0ZVJlZjxhbnk+PiA9IHt9O1xuICAgIGNvbXBvbmVudFF1ZXJ5LmZvckVhY2goKGNvbXBvbmVudCkgPT4ge1xuICAgICAgY3VzdG9tQ29tcG9uZW50c1tjb21wb25lbnQubmFtZV0gPSBjb21wb25lbnQudGVtcGxhdGU7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY3VzdG9tQ29tcG9uZW50cztcbiAgfVxufVxuIl19